<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Earth Data Explorer — 1D / 2D / 3D + Search</title>
  <style>
    :root {
      --bg: #0b1020; --panel: #121a33; --text: #e8ecff;
      --accent: #7aa2ff; --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text);
           font-family: ui-sans-serif, system-ui; }
    header { padding: 12px 18px; background: #0e1430;
             border-bottom: 1px solid rgba(255,255,255,.1); }
    header h1 { font-size: 18px; margin: 0; font-weight: 700; }
    .wrap { display: grid; grid-template-columns: 300px 1fr; gap: 12px; padding: 12px; }
    @media (max-width: 960px){ .wrap { grid-template-columns: 1fr; } }
    .panel { background: var(--panel); border: 1px solid rgba(255,255,255,.06);
             border-radius: 12px; padding: 12px; }
    h2 { font-size: 15px; margin-top: 12px; margin-bottom: 6px; }
    .btns { display:flex; flex-wrap: wrap; gap: 6px; margin: 6px 0; }
    button { border: 1px solid rgba(255,255,255,.2); background: #1a2448;
             color: var(--text); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
    button:hover { border-color: rgba(255,255,255,.4); }
    input, select { width: 100%; margin: 3px 0 6px; padding: 6px;
                    border: 1px solid rgba(255,255,255,.2); border-radius: 6px;
                    background: #0f1733; color: var(--text); }
    canvas { width: 100%; height: 80vh; border-radius: 12px;
             border: 1px solid rgba(255,255,255,.06); background:#000; }
    #strip { height: 200px; }
  </style>
</head>
<body>
  <header>
    <h1>Earth Data Explorer — 1D / 2D / 3D + Search</h1>
  </header>

  <div class="wrap">
    <section class="panel">
      <h2>1) View Modes</h2>
      <div class="btns">
        <button id="btn3D">3D Globe</button>
        <button id="btn2D">2D Map</button>
        <button id="btn1D">1D Strip</button>
      </div>
      <label>2D Projection</label>
      <select id="projection">
        <option value="equirect">Equirectangular</option>
        <option value="mercator">Mercator</option>
      </select>

      <h2>2) NASA Layers</h2>
      <div class="btns">
        <button id="btnTemp">+ Land Temp</button>
        <button id="btnFire">+ Fires</button>
        <button id="btnClearWms">Clear</button>
      </div>

      <h2>3) CSV → GeoJSON</h2>
      <input type="file" id="csvFile" accept=".csv" />
      <input id="lat" type="text" placeholder="lat column" />
      <input id="lon" type="text" placeholder="lon column" />
      <input id="alt" type="text" placeholder="alt (optional)" />
      <input id="nameCol" type="text" placeholder="name (optional)" />
      <div class="btns">
        <button id="btnPlot">Plot</button>
        <button id="btnDownload">Download</button>
        <button id="btnClearData">Clear</button>
        <button id="btnDemo">Demo CSV</button>
      </div>

      <h2>4) Go to Location</h2>
      <input type="text" id="gotoInput" placeholder="e.g. 28.6,77.2 or 'New Delhi'" />
      <div class="btns">
        <button id="btnGoto">Go To</button>
        <button id="btnClearPins">Clear Pins</button>
      </div>
    </section>

    <section>
      <canvas id="globe"></canvas>
      <canvas id="strip" style="display:none"></canvas>
    </section>
  </div>

  <!-- Libraries -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://files.worldwind.arc.nasa.gov/artifactory/web/0.11.0/worldwind.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Setup WorldWind globe
    var wwd = new WorldWind.WorldWindow("globe");
    wwd.addLayer(new WorldWind.BMNGLandsatLayer());
    wwd.addLayer(new WorldWind.CompassLayer());
    wwd.addLayer(new WorldWind.CoordinatesDisplayLayer(wwd));
    wwd.addLayer(new WorldWind.ViewControlsLayer(wwd));

    var dataLayer = new WorldWind.RenderableLayer("Data");
    wwd.addLayer(dataLayer);

    // -------- View modes --------
    function set3D(){ globeCanvas(); wwd.globe=new WorldWind.Globe(new WorldWind.EarthElevationModel()); wwd.redraw(); }
    function set2D(){ globeCanvas(); var g2d=new WorldWind.Globe2D(); g2d.elevationModel=new WorldWind.EarthElevationModel(); wwd.globe=g2d; setProjection(projection.value); }
    function setProjection(kind){ if(!(wwd.globe instanceof WorldWind.Globe2D)) return; wwd.projection=(kind==='mercator')?new WorldWind.ProjectionMercator():new WorldWind.ProjectionEquirectangular(); wwd.redraw(); }
    function set1D(){ document.getElementById('globe').style.display='none'; document.getElementById('strip').style.display='block'; drawStrip(); }
    function globeCanvas(){ document.getElementById('globe').style.display='block'; document.getElementById('strip').style.display='none'; }
    btn3D.onclick=set3D; btn2D.onclick=set2D; btn1D.onclick=set1D; projection.onchange=e=>setProjection(e.target.value);

    // -------- NASA GIBS WMS --------
    function addGibsWmsLayer(layerName, displayName){
      var service = "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi?SERVICE=WMS&REQUEST=GetCapabilities";
      $.get(service).done(xml=>{
        var wms=new WorldWind.WmsCapabilities(xml);
        var caps=wms.getNamedLayer(layerName);
        if(!caps){ alert("Layer not found: " + layerName); return; }
        var config=WorldWind.WmsLayer.formLayerConfiguration(caps);
        config.title=displayName;
        var layer=new WorldWind.WmsLayer(config);
        wwd.addLayer(layer);
      }).fail(()=>alert("NASA GIBS WMS not reachable"));
    }

    // Attach buttons to GIBS layers
    btnTemp.onclick=()=>addGibsWmsLayer('MODIS_Terra_Land_Surface_Temp_Day','Land Temp');
    btnFire.onclick=()=>addGibsWmsLayer('MODIS_Terra_Thermal_Anomalies_Day','Fires');
    btnClearWms.onclick=()=>{wwd.layers=wwd.layers.filter(l=>!(l instanceof WorldWind.WmsLayer)); wwd.redraw();};

    // -------- CSV → GeoJSON --------
    function csvToGeoJSON(rows, latKey, lonKey, altKey, nameKey){
      return {type:'FeatureCollection',features:rows.map(r=>{
        var lat=parseFloat(r[latKey]); var lon=parseFloat(r[lonKey]); var alt=altKey?parseFloat(r[altKey]):0;
        if(!Number.isFinite(lat)||!Number.isFinite(lon)) return null;
        var props={...r}; if(nameKey&&r[nameKey]) props.__label=r[nameKey];
        return {type:'Feature',geometry:{type:'Point',coordinates:[lon,lat,alt]},properties:props};
      }).filter(Boolean)};
    }
    function renderGeoJSON(geojson){
      var parser=new WorldWind.GeoJSONParser(geojson);
      parser.load(null,(g,p)=>{let cfg={}; if(g.type==='Point'){let a=new WorldWind.PlacemarkAttributes(null);a.imageScale=0.6; cfg.attributes=a; if(p.__label) cfg.name=p.__label;} return cfg;},dataLayer);
      wwd.redraw(); drawStrip();
    }
    var uploadedGeoJSON=null;
    csvFile.onchange=e=>{Papa.parse(e.target.files[0],{header:true,complete:r=>{window._csvRows=r.data; alert("CSV loaded");}});};
    btnPlot.onclick=()=>{if(!window._csvRows) return alert("Upload CSV"); uploadedGeoJSON=csvToGeoJSON(window._csvRows,lat.value,lon.value,alt.value,nameCol.value); renderGeoJSON(uploadedGeoJSON);};
    btnDownload.onclick=()=>{if(!uploadedGeoJSON) return alert("Nothing"); var blob=new Blob([JSON.stringify(uploadedGeoJSON,null,2)],{type:'application/geo+json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='data.geojson'; a.click();};
    btnClearData.onclick=()=>{dataLayer.removeAllRenderables(); wwd.redraw(); drawStrip();};
    btnDemo.onclick=()=>{var csv="name,lat,lon\nDelhi,28.6,77.2\nChennai,13.08,80.27"; var res=Papa.parse(csv,{header:true}); window._csvRows=res.data; uploadedGeoJSON=csvToGeoJSON(window._csvRows,'lat','lon','','name'); renderGeoJSON(uploadedGeoJSON);};

    // -------- 1D Strip --------
    var strip=document.getElementById('strip'); var sctx=strip.getContext('2d');
    function drawStrip(){
      var W=strip.width=strip.clientWidth, H=strip.height=strip.clientHeight;
      sctx.fillStyle='#0b1020'; sctx.fillRect(0,0,W,H);
      sctx.strokeStyle='rgba(255,255,255,0.2)'; sctx.beginPath(); sctx.moveTo(0,H-20); sctx.lineTo(W,H-20); sctx.stroke();
      [0,90,180,270,360].forEach(deg=>{var x=(deg/360)*W; sctx.fillStyle='rgba(255,255,255,0.6)'; sctx.fillRect(x-0.5,H-25,1,10); sctx.fillText(deg+'°',x-10,H-5);});
      var longs=[]; dataLayer.renderables.forEach(r=>{if(r&&r.position) longs.push((r.position.longitude+360)%360);});
      sctx.fillStyle='#7aa2ff'; longs.forEach(lon=>{var x=(lon/360)*W; var y=10+Math.random()*(H-40); sctx.beginPath(); sctx.arc(x,y,3,0,2*Math.PI); sctx.fill();});
      sctx.fillStyle='#fff'; sctx.fillText(longs.length+" pts",5,12);
    }

    // -------- Go To Location + Markers --------
    var markerLayer = new WorldWind.RenderableLayer("Markers");
    wwd.addLayer(markerLayer);

    function addMarker(lat, lon){
      var placemark=new WorldWind.Placemark(new WorldWind.Position(lat,lon,0),false,null);
      var attrs=new WorldWind.PlacemarkAttributes(null);
      attrs.imageScale=1.2;
      attrs.labelAttributes.color=WorldWind.Color.YELLOW;
      attrs.imageSource=WorldWind.configuration.baseUrl+"images/pushpins/plain-red.png";
      placemark.attributes=attrs;
      placemark.label=lat.toFixed(2)+", "+lon.toFixed(2);
      markerLayer.addRenderable(placemark);
      wwd.redraw();
    }

    btnGoto.onclick=function(){
      var val=document.getElementById('gotoInput').value.trim();
      if(!val) return;

      function goTo(lat,lon){
        var pos=new WorldWind.Position(lat,lon,800e3);
        wwd.goTo(pos);
        addMarker(lat,lon);
      }

      if(val.match(/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/)){
        var p=val.split(",");
        goTo(parseFloat(p[0]),parseFloat(p[1]));
      } else {
        fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(val))
          .then(r=>r.json()).then(results=>{
            if(results&&results.length>0){goTo(parseFloat(results[0].lat),parseFloat(results[0].lon));}
            else alert("Location not found: "+val);
          }).catch(err=>alert("Geocoding error: "+err));
      }
    };

    btnClearPins.onclick=function(){
      markerLayer.removeAllRenderables();
      wwd.redraw();
    };
  </script>
</body>
</html>
